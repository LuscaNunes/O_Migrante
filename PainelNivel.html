<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <title>Detalhes do Nível</title>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">
    <!-- Sidebar -->
    <div class="flex">
        <div class="bg-white w-64 p-6 shadow-lg fixed top-0 left-0 h-screen">
            <h2 class="text-2xl font-bold mb-6">Menu</h2>
            <ul>
                <li class="mb-4">
                    <a href="Painel.html"
                        class="flex items-center text-gray-700 hover:text-blue-500 hover:bg-blue-100 py-2 px-3 rounded">
                        <i class="fas fa-home mr-3"></i> Inicio
                    </a>
                </li>
                <li class="mb-4">
                    <a href="PaginaProducao.html"
                        class="flex items-center text-gray-700 hover:text-blue-500 hover:bg-blue-100 py-2 px-3 rounded">
                        <i class="fas fa-user mr-3"></i> Perfil
                    </a>
                </li>
                <li class="mb-4">
                    <a href="PaginaProducao.html"
                        class="flex items-center text-gray-700 hover:text-blue-500 hover:bg-blue-100 py-2 px-3 rounded">
                        <i class="fas fa-scroll mr-3"></i> Pergaminho
                    </a>
                </li>
                <li class="mb-4">
                    <a href="Fases.html"
                        class="flex items-center text-gray-700 hover:text-blue-500 hover:bg-blue-100 py-2 px-3 rounded">
                        <i class="fas fa-tasks mr-3"></i> Missão
                    </a>
                </li>
                <li class="mb-4">
                    <a href="PaginaProducao.html"
                        class="flex items-center text-gray-700 hover:text-blue-500 hover:bg-blue-100 py-2 px-3 rounded">
                        <i class="fas fa-bell mr-3"></i> Notificação
                    </a>
                </li>
                <li class="mb-4">
                    <a href="PaginaProducao.html"
                        class="flex items-center text-gray-700 hover:text-blue-500 hover:bg-blue-100 py-2 px-3 rounded">
                        <i class="fas fa-user-friends mr-3"></i> Amigos
                    </a>
                </li>
                <li class="mb-4">
                    <a href="PaginaProducao.html"
                        class="flex items-center text-gray-700 hover:text-blue-500 hover:bg-blue-100 py-2 px-3 rounded">
                        <i class="fas fa-blog mr-3"></i> Blog
                    </a>
                </li>
                <li id="adminDropdown" class="mb-4 hidden">
                    <div class="relative">
                        <button id="adminMenuButton"
                            class="flex items-center text-gray-700 hover:text-blue-500 hover:bg-blue-100 py-2 px-3 rounded w-full">
                            <i class="fas fa-cog mr-3"></i> Administração
                            <i class="fas fa-chevron-down ml-auto"></i>
                        </button>
                        <ul id="adminMenuItems" class="hidden absolute left-0 mt-2 w-48 bg-white shadow-lg rounded-lg">
                            <li>
                                <a href="PesquisaUsuario.html"
                                    class="block px-4 py-2 text-gray-700 hover:text-blue-500 hover:bg-blue-100">Usuários</a>
                            </li>
                            <li>
                                <a href="CaPerguntas.html"
                                    class="block px-4 py-2 text-gray-700 hover:text-blue-500 hover:bg-blue-100">Cadastrar
                                    Perguntas</a>
                            </li>
                            <li>
                                <a href="DadosFases.html"
                                    class="block px-4 py-2 text-gray-700 hover:text-blue-500 hover:bg-blue-100">Dados
                                    das Fases</a>
                            </li>
                        </ul>
                    </div>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col items-center justify-center p-8 ml-64">
            <h1 id="nivelTitle" class="text-4xl font-bold text-center mb-4">Carregando...</h1>
            <h2 id="nivelDescription" class="text-2xl text-center mb-8">Carregando descrição...</h2>

            <!-- Botão 1 -->
            <button style="top: 150px; left: 650px;"
                class="absolute w-32 h-32 text-white text-5xl rounded-full flex items-center justify-center hover-animate shadow-lg nivel-button"
                data-ordem="1" onclick="redirectToPerguntas(1)">
                1
            </button>
            <!-- Bolinha entre 1 e 2 -->
            <div style="top: 295px; left: 655px;" class="absolute w-8 h-8 bg-blue-500 rounded-full shadow-lg"></div>

            <!-- Botão 2 -->
            <button style="top: 350px; left: 580px;"
                class="absolute w-32 h-32 text-white text-3xl rounded-full flex items-center justify-center hover-animate shadow-lg nivel-button"
                data-ordem="2" onclick="redirectToPerguntas(2)" disabled>
                2
            </button>
            <!-- Bolinha entre 2 e 3 -->
            <div style="top: 505px; left: 580px;" class="absolute w-8 h-8 bg-blue-500 rounded-full shadow-lg"></div>

            <!-- Botão 3 -->
            <button style="top: 575px; left: 500px;"
                class="absolute w-32 h-32 text-white text-3xl rounded-full flex items-center justify-center hover-animate shadow-lg nivel-button"
                data-ordem="3" onclick="redirectToPerguntas(3)" disabled>
                3
            </button>
            <!-- Bolinha entre 3 e 4 -->
            <div style="top: 720px; left: 550px;" class="absolute w-8 h-8 bg-blue-500 rounded-full shadow-lg"></div>

            <!-- Botão 4 -->
            <button style="top: 770px; left: 530px;"
                class="absolute w-32 h-32 text-white text-3xl rounded-full flex items-center justify-center hover-animate shadow-lg nivel-button"
                data-ordem="4" onclick="redirectToPerguntas(4)" disabled>
                4
            </button>
            <!-- Bolinha entre 4 e 5 -->
            <div style="top: 910px; left: 605px;" class="absolute w-8 h-8 bg-blue-500 rounded-full shadow-lg"></div>

            <!-- Botão 5 -->
            <button style="top: 950px; left: 600px;"
                class="absolute w-32 h-32 text-white text-3xl rounded-full flex items-center justify-center hover-animate shadow-lg nivel-button"
                data-ordem="5" onclick="redirectToPerguntas(5)" disabled>
                5
            </button>
            <!-- Bolinha entre 5 e 6 -->
            <div style="top: 1100px; left: 695px;" class="absolute w-8 h-8 bg-blue-500 rounded-full shadow-lg"></div>

            <!-- Botão 6 -->
            <button style="top: 1140px; left: 700px;"
                class="absolute w-32 h-32 text-white text-3xl rounded-full flex items-center justify-center hover-animate shadow-lg nivel-button"
                data-ordem="6" onclick="redirectToPerguntas(6)" disabled>
                6
            </button>
            <!-- Bolinha entre 6 e 7 -->
            <div style="top: 1295px; left: 775px;" class="absolute w-8 h-8 bg-blue-500 rounded-full shadow-lg"></div>

            <!-- Botão 7 -->
            <button style="top: 1355px; left: 750px;"
                class="absolute w-32 h-32 text-white text-3xl rounded-full flex items-center justify-center hover-animate shadow-lg nivel-button"
                data-ordem="7" onclick="redirectToPerguntas(7)" disabled>
                7
            </button>
            <!-- Bolinha entre 7 e 8 -->
            <div style="top: 1499px; left: 760px;" class="absolute w-8 h-8 bg-blue-500 rounded-full shadow-lg"></div>

            <!-- Botão 8 -->
            <button style="top: 1550px; left: 680px;"
                class="absolute w-32 h-32 text-white text-3xl rounded-full flex items-center justify-center hover-animate shadow-lg nivel-button"
                data-ordem="8" onclick="redirectToPerguntas(8)" disabled>
                8
            </button>
            <!-- Bolinha entre 8 e 9 -->
            <div style="top: 1690px; left: 675px;" class="absolute w-8 h-8 bg-blue-500 rounded-full shadow-lg"></div>

            <!-- Botão 9 -->
            <button style="top: 1740px; left: 580px;"
                class="absolute w-32 h-32 text-white text-3xl rounded-full flex items-center justify-center hover-animate shadow-lg nivel-button"
                data-ordem="9" onclick="redirectToPerguntas(9)" disabled>
                9
            </button>
            <!-- Bolinha entre 9 e 10 -->
            <div style="top: 1890px; left: 605px;" class="absolute w-8 h-8 bg-blue-500 rounded-full shadow-lg"></div>

            <!-- Botão 10 -->
            <button style="top: 1950px; left: 550px;"
                class="absolute w-32 h-32 text-white text-3xl rounded-full flex items-center justify-center hover-animate shadow-lg nivel-button"
                data-ordem="10" onclick="redirectToPerguntas(10)" disabled>
                10
            </button>
            <!-- Bolinha entre 10 e 11 -->
            <div style="top: 2105px; left: 605px;" class="absolute w-8 h-8 bg-blue-500 rounded-full shadow-lg"></div>

            <!-- Botão 11 -->
            <button style="top: 2150px; left: 600px;"
                class="absolute w-32 h-32 text-white text-3xl rounded-full flex items-center justify-center hover-animate shadow-lg nivel-button"
                data-ordem="11" onclick="redirectToPerguntas(11)" disabled>
                11
            </button>
            <!-- Bolinha entre 11 e 12 -->
            <div style="top: 2300px; left: 665px;" class="absolute w-8 h-8 bg-blue-500 rounded-full shadow-lg"></div>

            <!-- Botão 12 -->
            <button style="top: 2350px; left: 650px;"
                class="absolute w-32 h-32 text-white text-3xl rounded-full flex items-center justify-center hover-animate shadow-lg nivel-button"
                data-ordem="12" onclick="redirectToPerguntas(12)" disabled>
                12
            </button>
        </main>
    </div>

    <script>
        // Função para redirecionar para a página de perguntas
        function redirectToPerguntas(numeroPergunta) {
            const nivelId = new URLSearchParams(window.location.search).get('nivel_id');
            if (!nivelId || isNaN(parseInt(nivelId))) {
                alert("ID do nível inválido.");
                return;
            }

            // Verifica se o botão está habilitado
            const botao = document.querySelector(`.nivel-button[data-ordem="${numeroPergunta}"]`);
            if (botao && botao.disabled) {
                alert("Você precisa completar as perguntas anteriores para acessar esta fase.");
                return;
            }

            // Passa tanto o nivel_id quanto o número da pergunta (ordem)
            window.location.href = `TelaPergunta.html?nivel_id=${nivelId}&ordem=${numeroPergunta}`;
        }

        // Verifica autenticação ao carregar a página
        document.addEventListener("DOMContentLoaded", () => {
            const token = localStorage.getItem('token');
            if (!token) {
                alert("Você precisa estar logado para acessar esta página.");
                window.location.href = "index.html";
                return;
            }

            // Obtém o ID do nível da URL
            const urlParams = new URLSearchParams(window.location.search);
            const nivelId = urlParams.get('nivel_id');
            if (!nivelId || isNaN(parseInt(nivelId))) {
                alert("ID do nível inválido.");
                window.location.href = "Fases.html";
                return;
            }

            // Verifica o token e exibe o menu de administração se for administrador
            fetch("http://localhost:3000/verifyToken", {
                method: "GET",
                headers: { "Authorization": token }
            })
                .then(res => res.json())
                .then(data => {
                    if (!data.auth || (data.user.tipo !== 'admin' && data.user.tipo !== 'user')) {
                        localStorage.removeItem('token');
                        alert("Token inválido ou usuário sem permissão.");
                        window.location.href = "index.html";
                    } else {
                        // Mostra o menu "Administração" apenas para admins
                        if (data.user.tipo === 'admin') {
                            const adminDropdown = document.getElementById('adminDropdown');
                            adminDropdown.classList.remove('hidden');

                            // Lógica do dropdown
                            const adminMenuButton = document.getElementById('adminMenuButton');
                            const adminMenuItems = document.getElementById('adminMenuItems');

                            adminMenuButton.addEventListener('click', (e) => {
                                e.stopPropagation();
                                adminMenuItems.classList.toggle('hidden');
                            });

                            document.addEventListener('click', (e) => {
                                if (!adminMenuButton.contains(e.target) && !adminMenuItems.contains(e.target)) {
                                    adminMenuItems.classList.add('hidden');
                                }
                            });
                        }

                        // Carrega os dados do nível e o progresso
                        loadNivelData(nivelId);
                        carregarProgressoBotoes(nivelId);
                    }
                })
                .catch(error => {
                    console.error("Erro ao verificar token:", error);
                    alert("Erro ao verificar autenticação. Verifique o console.");
                    window.location.href = "index.html";
                });
        });

        // Função para carregar os dados do nível
        function loadNivelData(nivelId) {
            console.log("Carregando dados do nível:", nivelId);

            fetch(`http://localhost:3000/niveis/${nivelId}`, {
                method: "GET",
                headers: { "Authorization": localStorage.getItem('token') }
            })
                .then(res => {
                    console.log("Resposta da API /niveis:", res);
                    if (!res.ok) {
                        return res.json().then(err => {
                            throw new Error(`Erro ${res.status}: ${err.error || res.statusText}`);
                        });
                    }
                    return res.json();
                })
                .then(data => {
                    console.log("Dados do nível recebidos:", data);

                    // Verifica se os dados estão presentes e têm as propriedades esperadas
                    if (!data || !data.titulo || !data.descricao) {
                        throw new Error("Dados do nível inválidos ou não encontrados.");
                    }

                    // Define os elementos HTML com base nos dados recebidos
                    document.getElementById("nivelTitle").textContent = data.titulo;
                    document.getElementById("nivelDescription").textContent = data.descricao;
                })
                .catch(error => {
                    console.error("Erro ao carregar dados do nível:", error);
                    alert(`Erro ao carregar dados do nível: ${error.message}`);
                    window.location.href = "Fases.html";
                });
        }

        // Função para carregar o progresso dos botões
        async function carregarProgressoBotoes(nivelId) {
            try {
                console.log("Carregando progresso para nível:", nivelId);
                const response = await fetch(`http://localhost:3000/progresso/botoes/${nivelId}`, {
                    method: "GET",
                    headers: { "Authorization": localStorage.getItem('token') }
                });
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(`Erro ${response.status}: ${err.error || response.statusText}`);
                    });
                }
                const data = await response.json();
                console.log("Progresso recebido:", data);

                // Habilitar/desabilitar botões com base no progresso
                const botoes = document.querySelectorAll('.nivel-button');
                let ultimoBotaoConcluido = 0;
                for (let i = 1; i <= 12; i++) {
                    if (data.botoesCompletos[i]?.concluido) {
                        ultimoBotaoConcluido = i;
                    }
                }

                botoes.forEach((botao) => {
                    const botaoOrdem = parseInt(botao.dataset.ordem);

                    // Remover classes anteriores
                    botao.classList.remove('bloqueado', 'disponivel', 'concluido');

                    if (data.botoesCompletos[botaoOrdem]?.concluido) {
                        // Botão concluído (verde)
                        botao.classList.add('concluido');
                        botao.disabled = false; // Permitir repetir
                    } else if (botaoOrdem <= ultimoBotaoConcluido + 1) {
                        // Botão disponível (azul)
                        botao.classList.add('disponivel');
                        botao.disabled = false;
                    } else {
                        // Botão bloqueado (vermelho)
                        botao.classList.add('bloqueado');
                        botao.disabled = true;
                    }
                });
            } catch (error) {
                console.error("Erro ao carregar progresso dos botões:", error);
                alert(`Erro ao carregar progresso: ${error.message}`);
            }
        }
    </script>

    <style>
        .nivel-button {
            background-color: #007bff; /* Cor padrão (azul) para botões */
            transition: background-color 0.3s ease;
        }

        .nivel-button.bloqueado {
            background-color: #ff0000; /* Vermelho para botões bloqueados */
        }

        .nivel-button.disponivel {
            background-color: #007bff; /* Azul para botões disponíveis */
        }

        .nivel-button.concluido {
            background-color: #28a745; /* Verde para botões concluídos */
        }

        .nivel-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .hover-animate:hover:not(:disabled) {
            transform: scale(1.05);
        }
    </style>
</body>
</html>